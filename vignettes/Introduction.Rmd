---
title: "Introduction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r run example model}
library(rstan)
library(bennu)
library(bayesplot)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores(logical = FALSE))

## basic example code
d <- generate_model_data()
# note iter should be at least 2000 to generate a reasonable posterior sample
fit <- est_naloxone(d,iter=500)
mcmc_pairs(fit, pars = c("sigma","mu0","zeta"),
           off_diag_args = list(size = 1, alpha = 0.5))
```

Return median and 90th percentiles for posterior samples

```{r summarize draws}
library(posterior)

summarise_draws(fit, default_summary_measures())
```

The second model uses a random walk of order 1 to characterize the time-dependence
structure of the inverse logit probability of naloxone use,

$$\Delta^2c_i = c_i - c_{i+1} \sim N(0,\tau^{-1})  $$

The model can also be fit using a random walk of order 2 increments for the inverse logit probability of naloxone use using the following independent second order increments,

$$\Delta^2c_i = c_i - 2c_{i+1} + c_{i+2} \sim N(0,\tau^{-1}) $$

This version of the model will produce smoother estimates of probability of
naloxone use in time.

```{r rw order 2 model}
# note iter should be at least 2000 to generate a reasonable posterior sample
# note use `rw_type` to specify order of random walk
rw2_fit <- est_naloxone(d,
                    rw_type = 2,
                    iter=500)
mcmc_pairs(fit, pars = c("sigma","mu0","zeta"),
           off_diag_args = list(size = 1, alpha = 0.5))
```


Summarize random walk order 2 model draws

```{r rw order 2 summary draws}
summarise_draws(rw2_fit, default_convergence_measures())
```



```{r plot draws}
library(ggplot2)
library(dplyr)
library(tidybayes)

rw1_p <- fit %>% 
  tidybayes::spread_draws(p[i]) %>% 
  mutate(model = "RW 1") %>% 
  dplyr::left_join(
    dplyr::mutate(d,i = dplyr::row_number()),
    by="i"
  ) 

rw2_p <- rw2_fit %>% 
  tidybayes::spread_draws(p[i]) %>% 
  mutate(model = "RW 2") %>% 
  dplyr::left_join(
    dplyr::mutate(d,i = dplyr::row_number()),
    by="i"
  ) 
region <- model <- times <- NULL

p_dat <-  rw1_p %>% 
  bind_rows(rw2_p) %>% 
  dplyr::group_by(region_name,model, times) %>%
  dplyr::summarise(
    p50 = stats::quantile(p,0.5),
    p25 = stats::quantile(p,0.25),
    p75 = stats::quantile(p,0.75),
    p05 = stats::quantile(p,0.05),
    p95 = stats::quantile(p,0.95),
    p_use = mean(p_use))
  
  p_use_plot <- p_dat %>% 
    mutate(region_name = as.factor(region_name)) %>% 
    ggplot2::ggplot(ggplot2::aes(x=times)) +
    ggplot2::geom_line(
        ggplot2::aes(y=p50,color=region_name)) + ggplot2::geom_ribbon(
            ggplot2::aes(ymin=p05,ymax=p95,fill=region_name),alpha=0.2) + 
    ggplot2::geom_ribbon(
        ggplot2::aes(ymin=p25,ymax=p75,fill=region_name),alpha=0.2) +
    ggplot2::geom_point(ggplot2::aes(y=p_use,color=region_name)) +
    facet_wrap(ggplot2::vars(model))
  
  p_use_plot
```
